# Fastfile for LiteByte iOS Build Automation
# This fastlane configuration handles uploading builds to TestFlight

default_platform(:ios)

# Disable analytics and junit to avoid encoding issues
opt_out_usage
ENV['FASTLANE_SKIP_JUNIT'] = '1'

platform :ios do
  desc "Upload iOS build to TestFlight"
  lane :tf_upload do |options|
    begin
      # Get the IPA path from options or fallback search
      ipa_path = options[:ipa_path] || Dir.glob("../.build/last/*.ipa").first || Dir.glob("*.ipa").first
      
      if ipa_path.nil? || !File.exist?(ipa_path)
        UI.user_error!("‚ùå No IPA file found at: #{ipa_path || 'any standard path'}")
      end
      
      UI.success("üì¶ Found IPA: #{ipa_path}")
      
      # Get API key from environment
      api_key_base64 = ENV['APPLE_AUTH_LITEBYTE']
      issuer_id = ENV['APPLE_ISSUER_ID']
      key_id = "5NK3TP4SCM"
      
      if api_key_base64.nil? || issuer_id.nil?
        UI.user_error!("‚ùå APPLE_AUTH_LITEBYTE or APPLE_ISSUER_ID not set in environment")
      end
      
      # Decode API key
      require 'base64'
      key_content = Base64.decode64(api_key_base64)
      
      UI.message("üîê Using App Store Connect API key authentication")
      
      # Use api_key hash instead of api_key_path to avoid file encoding issues
      api_key = {
        key_id: key_id,
        issuer_id: issuer_id,
        key: key_content
      }
      
      # Upload to TestFlight
      upload_to_testflight(
        ipa: ipa_path,
        api_key: api_key,
        app_identifier: "com.liithos.litebyte",
        skip_waiting_for_build_processing: true,
        skip_submission: true,
        distribute_external: false,
        notify_external_testers: false
      )
      
      UI.success("‚úÖ Successfully uploaded to TestFlight!")
      UI.message("üì± Check status: https://appstoreconnect.apple.com")
      
    rescue ArgumentError => e
      # Catch UTF-8 encoding errors from JUnit generator
      if e.message.include?("invalid byte sequence in UTF-8")
        UI.important("‚ö†Ô∏è  Ignoring JUnit generator encoding error (known Fastlane bug)")
        exit(0)
      else
        raise e
      end
    end
  end
end
