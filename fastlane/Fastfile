# Fastfile for LiteByte iOS Build Automation
# This fastlane configuration handles uploading builds to TestFlight

default_platform(:ios)

platform :ios do
  desc "Upload iOS build to TestFlight"
  lane :tf_upload do |options|
    # Get the IPA path from options or fallback search
    ipa_path = options[:ipa_path] || Dir.glob("../.build/last/*.ipa").first || Dir.glob("*.ipa").first
    
    if ipa_path.nil? || !File.exist?(ipa_path)
      UI.user_error!("‚ùå No IPA file found at: #{ipa_path || 'any standard path'}")
    end
    
    UI.success("üì¶ Found IPA: #{ipa_path}")
    
    # Get API key from environment
    api_key_base64 = ENV['APPLE_AUTH_LITEBYTE']
    issuer_id = ENV['APPLE_ISSUER_ID']
    
    if api_key_base64.nil? || issuer_id.nil?
      UI.user_error!("‚ùå APPLE_AUTH_LITEBYTE or APPLE_ISSUER_ID not set in environment")
    end
    
    # Create temporary API key file
    require 'base64'
    require 'tempfile'
    
    temp_file = Tempfile.new(['AuthKey', '.p8'])
    temp_file.write(Base64.decode64(api_key_base64))
    temp_file.close
    
    UI.message("üîê Using App Store Connect API key authentication")
    
    # Upload to TestFlight
    upload_to_testflight(
      ipa: ipa_path,
      api_key_path: temp_file.path,
      api_key: {
        key_id: "5NK3TP4SCM",
        issuer_id: issuer_id,
        key_filepath: temp_file.path
      },
      app_identifier: "com.liithos.litebyte",
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    )
    
    # Clean up temp file
    temp_file.unlink
    
    UI.success("‚úÖ Successfully uploaded to TestFlight!")
    UI.message("üì± Check status: https://appstoreconnect.apple.com")
  end
end
