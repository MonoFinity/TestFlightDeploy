# Fastfile for LiteByte iOS Build Automation
# This fastlane configuration handles uploading builds to TestFlight

default_platform(:ios)

# Disable analytics and junit to avoid encoding issues
opt_out_usage
ENV['FASTLANE_SKIP_JUNIT'] = '1'

platform :ios do
  desc "Upload iOS build to TestFlight"
  lane :tf_upload do |options|
    begin
      # Get the IPA path from options or fallback search
      ipa_path = options[:ipa_path] || Dir.glob("../.build/last/*.ipa").first || Dir.glob("*.ipa").first
      
      if ipa_path.nil? || !File.exist?(ipa_path)
        UI.user_error!("No IPA file found at: #{ipa_path || 'any standard path'}")
      end
      
      UI.success("Found IPA: #{ipa_path}")
      
      # Get Apple credentials from environment
      apple_id = ENV['APPLE_ID']
      app_password = ENV['APPLE_APP_SPECIFIC_PASSWORD']
      
      if apple_id.nil? || app_password.nil?
        UI.user_error!("APPLE_ID or APPLE_APP_SPECIFIC_PASSWORD not set in environment")
      end
      
      UI.message("Using Apple ID authentication")
      UI.message("Apple ID: #{apple_id}")
      
      # Upload to TestFlight using Apple ID + app-specific password
      upload_to_testflight(
        ipa: ipa_path,
        username: apple_id,
        app_identifier: "com.liithos.litebyte",
        skip_waiting_for_build_processing: true,
        skip_submission: true,
        distribute_external: false,
        notify_external_testers: false
      )
      
      UI.success("Successfully uploaded to TestFlight!")
      UI.message("Check status: https://appstoreconnect.apple.com")
      
    rescue ArgumentError => e
      # Catch UTF-8 encoding errors from JUnit generator
      if e.message.include?("invalid byte sequence in UTF-8")
        UI.important("Ignoring JUnit generator encoding error (known Fastlane bug)")
        exit(0)
      else
        raise e
      end
    end
  end
end
